---
title: "Which fish to do metagenomics on?"
author: "Lei Ma"
output: github_document
date: "Last compiled on `r format(Sys.time(), '%d %B, %Y')`"
---

```{r libraries, echo=FALSE, include=TRUE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, include=TRUE, fig.width=12)
knitr::knit_hooks$set(inline = function(x) if(is.numeric(x)){format(x,digits=2)}else{x})

#misc
library(here)

#data manipulations
library(tidyverse)
library(microbiome)

#plotting stuff
library(ggplot2)
library(cowplot)

#analysis
library(phyloseq)
library(vegan)
```

```{r data}
ps <- readRDS(here("data/processed/ps.rds"))
ps.rel <- readRDS(here("data/processed/psrel.rds"))
metadata <- read.delim(here("data/processed/metadata.csv"), ",", header = TRUE, row.names=1, check.names=FALSE)
```

## Criteria

Criteria for good metagenomics candidates:

* Few chloroplast sequences
* male fish only in case of sex effect
* Representative host genotypes, as determined by PCR with RF1 and IR1 reverse primers
* faint bands in host genotyping PCR, perhaps? Or bright bands? Faint might indicate low host DNA or PCR inhibitors. Bright might indicate high host DNA.

## Chloroplasts

Looks like there's plenty of choice if we filter out fish with chloroplast abundance less than 10%
```{r chloroplast}
ggplot(sample_data(ps) %>% subset_samples(sampleType=="gut"), aes(x=reorder(sample, chl_abundance), y=chl_abundance, color=ifelse(chl_abundance<0.1, "good", "too much")))+geom_point()+facet_wrap(~fishType, scales="free_x") + labs(y="Chloroplast relative abundance (before removal)")
```

Let's look at the distribution of host genotypes (before and after removing the high chloroplast fish). Incidentally, I think it's interesting that the distribution of genotypes is so similar for the wild fish. 
```{r host genotypes}
b<-meta(ps) %>% filter(!is.na(genotype) & sampleType=="gut")
a<-meta(ps %>% subset_samples(chl_abundance <0.1)) %>% filter(!is.na(genotype) & sampleType=="gut")
ggplot(b, aes(x=genotype)) + geom_bar(position="stack") + geom_bar(data=a, fill="red")+facet_wrap(~fishType) + labs("Distribution of genotypes before removing high chloroplast fish")
```

We also want to narrow by sex